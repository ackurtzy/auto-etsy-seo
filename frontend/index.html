<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Auto Etsy SEO – Local API Tester</title>
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #0f172a;
        color: #e2e8f0;
        line-height: 1.4;
      }

      header,
      main {
        max-width: 2000px;
        margin: 0 auto;
        padding: 1.5rem;
      }

      header h1 {
        margin-bottom: 0.25rem;
      }

      a {
        color: #38bdf8;
      }

      .panel {
        background: #1e293b;
        border: 1px solid #334155;
        border-radius: 0.75rem;
        padding: 1rem;
        margin-bottom: 1.5rem;
      }

      .panel h2 {
        margin-top: 0;
      }

      label {
        display: block;
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
      }

      input,
      textarea,
      select {
        width: 100%;
        padding: 0.6rem;
        border-radius: 0.5rem;
        border: 1px solid #475569;
        background: #0f172a;
        color: #f8fafc;
        font-size: 0.95rem;
        margin-bottom: 0.75rem;
      }

      textarea {
        min-height: 4rem;
        resize: vertical;
      }

      .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      button {
        border: none;
        border-radius: 999px;
        padding: 0.6rem 1.2rem;
        font-size: 0.9rem;
        cursor: pointer;
        transition: opacity 0.2s ease;
      }

      button.primary {
        background: #38bdf8;
        color: #0f172a;
      }

      button.secondary {
        background: #475569;
        color: #f1f5f9;
      }

      button.danger {
        background: #ef4444;
        color: #fff;
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .stack {
        display: grid;
        gap: 0.75rem;
      }

      .log {
        max-height: 420px;
        overflow-y: auto;
        display: grid;
        gap: 0.75rem;
      }

      .log-entry {
        background: #0f172a;
        border: 1px solid #1e293b;
        border-radius: 0.75rem;
        padding: 0.75rem;
      }

      .log-entry h3 {
        margin: 0 0 0.5rem;
        font-size: 1rem;
      }

      .log-entry pre {
        margin: 0;
        white-space: pre-wrap;
        word-break: break-word;
      }

      .log-entry.error {
        border-color: #ef4444;
      }

      .checkbox-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        font-size: 0.9rem;
      }

      .checkbox-row input {
        width: auto;
        margin: 0;
      }

      @media (min-width: 768px) {
        .split {
          display: grid;
          grid-template-columns: repeat(2, minmax(0, 1fr));
          gap: 1rem;
        }
      }

      .step-panel {
        border: 1px solid #334155;
        border-radius: 0.75rem;
        padding: 0.75rem;
        background: #101d35;
        margin-top: 0.75rem;
      }

      .step-panel h3 {
        margin: 0 0 0.25rem;
        font-size: 1rem;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Auto Etsy SEO – Local API Tester</h1>
      <p>
        Quick MVP UI to exercise the Flask backend. Update the base URL if the
        API is on a different port/host, then use the panels below to call the
        routes. Raw responses will be added to the log for inspection.
      </p>
    </header>
    <main style="display: flex; gap: 1rem">
      <div style="flex: 1; display: grid; gap: 1.5rem">
        <section class="panel">
          <h2>Backend Connection</h2>
          <div class="stack">
            <label>
              Base URL
              <input
                id="base-url"
                type="text"
                value="http://localhost:8000"
                placeholder="http://localhost:8000"
              />
            </label>
            <div class="actions">
              <button id="health-btn" class="secondary">Health Check</button>
              <button id="listings-btn" class="secondary">List Listings</button>
              <button id="proposals-btn" class="secondary">
                List Proposals
              </button>
              <button id="experiments-btn" class="secondary">
                List Experiments
              </button>
              <button id="testing-btn" class="secondary">List Testing</button>
              <button id="untested-btn" class="secondary">List Untested</button>
              <button id="reports-btn" class="secondary">List Reports</button>
              <button id="insights-btn" class="secondary">
                List Active Insights
              </button>
              <button id="clear-log-btn" class="danger">Clear Log</button>
            </div>
          </div>
        </section>

        <section class="panel">
          <h2>Sync Cached Data</h2>
          <form id="sync-form" class="stack">
            <label>
              Limit (default 100)
              <input
                type="number"
                name="limit"
                placeholder="100"
                min="1"
                step="1"
              />
            </label>
            <label>
              Keywords (optional)
              <input
                type="text"
                name="keywords"
                placeholder="wedding invitation"
              />
            </label>
            <div class="checkbox-row">
              <input
                type="checkbox"
                id="sync-images"
                name="sync_images"
                value="true"
                checked
              />
              <label for="sync-images">Sync images for all listings</label>
            </div>
            <div class="stack split">
              <label>
                Listing IDs (comma separated – optional)
                <input type="text" name="listing_ids" placeholder="1111,2222" />
              </label>
              <label>
                Sort on (default created)
                <input type="text" name="sort_on" placeholder="created" />
              </label>
              <label>
                Sort order (default desc)
                <input type="text" name="sort_order" placeholder="desc" />
              </label>
            </div>
            <button type="submit" class="primary">Run Sync</button>
          </form>
        </section>

        <section class="panel">
          <h2>Listing Search</h2>
          <form id="listings-filter-form" class="split">
            <div>
              <label>Listing IDs</label>
              <input
                type="text"
                name="ids"
                placeholder="Filter by comma separated IDs"
              />
            </div>
            <div>
              <label>Title Search</label>
              <input
                type="text"
                name="search"
                placeholder="part of the title"
              />
            </div>
            <div>
              <label>State</label>
              <input type="text" name="state" placeholder="active" />
            </div>
            <button type="submit" class="primary">Fetch Listings</button>
          </form>
        </section>

        <section class="panel">
          <h2>Generate Proposals</h2>
          <form id="generate-proposals-form" class="stack">
            <label>
              Listing IDs (comma separated)
              <textarea
                name="listing_ids"
                placeholder="4332016634, 123456789"
                required
              ></textarea>
            </label>
            <div class="checkbox-row">
              <input
                type="checkbox"
                id="include-prior"
                name="include_prior_experiments"
                value="true"
                checked
              />
              <label for="include-prior"
                >Include prior experiments in the LLM prompt</label
              >
            </div>
            <label>
              Max prior experiments
              <input
                type="number"
                name="max_prior_experiments"
                placeholder="5"
                min="1"
              />
            </label>
            <button type="submit" class="primary">Generate Proposals</button>
          </form>
        </section>

        <section class="panel">
          <h2>Evaluate Experiment</h2>
          <form id="evaluate-form" class="split">
            <div>
              <label>Listing ID</label>
              <input
                type="number"
                name="listing_id"
                placeholder="4332016634"
                required
              />
            </div>
            <div>
              <label>Experiment ID</label>
              <input
                type="text"
                name="experiment_id"
                placeholder="experiment uuid"
                required
              />
            </div>
            <div>
              <label>Tolerance (default 0)</label>
              <input
                type="number"
                name="tolerance"
                placeholder="0"
                step="0.1"
              />
            </div>
            <div>
              <label>Comparison Date (optional)</label>
              <input
                type="text"
                name="comparison_date"
                placeholder="2024-09-30"
              />
            </div>
            <button type="submit" class="primary">Evaluate</button>
          </form>
        </section>

        <section class="panel">
          <h2>Experiment Actions</h2>
          <div class="stack">
            <form id="accept-form" class="split">
              <div>
                <label>Listing ID</label>
                <input
                  type="number"
                  name="listing_id"
                  placeholder="4332016634"
                  required
                />
              </div>
              <div>
                <label>Experiment ID</label>
                <input
                  type="text"
                  name="experiment_id"
                  placeholder="experiment uuid"
                  required
                />
              </div>
              <button type="submit" class="secondary">
                Apply Changes (Testing)
              </button>
            </form>
            <form id="keep-form" class="split">
              <div>
                <label>Listing ID</label>
                <input
                  type="number"
                  name="listing_id"
                  placeholder="4332016634"
                  required
                />
              </div>
              <div>
                <label>Experiment ID</label>
                <input
                  type="text"
                  name="experiment_id"
                  placeholder="experiment uuid"
                  required
                />
              </div>
              <button type="submit" class="secondary">Mark Kept</button>
            </form>
            <form id="revert-form" class="split">
              <div>
                <label>Listing ID</label>
                <input
                  type="number"
                  name="listing_id"
                  placeholder="4332016634"
                  required
                />
              </div>
              <div>
                <label>Experiment ID</label>
                <input
                  type="text"
                  name="experiment_id"
                  placeholder="experiment uuid"
                  required
                />
              </div>
              <button type="submit" class="danger">Revert Experiment</button>
            </form>
          </div>
        </section>

        <section class="panel">
          <h2>Reports &amp; Insights</h2>
          <div class="step-panel">
            <h3>Step 1 · Generate report</h3>
            <form id="generate-report-form" class="split">
              <div>
                <label>Days Back (completed experiment window)</label>
                <input
                  type="number"
                  name="days_back"
                  placeholder="30"
                  min="1"
                  required
                />
              </div>
              <button type="submit" class="primary">Generate Report</button>
            </form>
          </div>

          <div class="step-panel">
            <h3>Step 2 · Activate insights</h3>
            <form id="activate-insights-form" class="stack">
              <label>
                Report ID (from the Generate Report log entry)
                <input
                  type="text"
                  name="report_id"
                  placeholder="report uuid"
                  required
                />
              </label>
              <label>
                Insight IDs (comma separated, from the same log entry)
                <input
                  type="text"
                  name="insight_ids"
                  placeholder="insight1, insight2"
                  required
                />
              </label>
              <button type="submit" class="secondary">Activate Insights</button>
            </form>
          </div>

          <div class="step-panel">
            <h3>Step 3 · Deactivate insights</h3>
            <form id="deactivate-insights-form" class="stack">
              <label>
                Insight IDs to deactivate (comma separated)
                <input
                  type="text"
                  name="insight_ids"
                  placeholder="insight1, insight2"
                  required
                />
              </label>
              <button type="submit" class="danger">Deactivate Insights</button>
            </form>
          </div>
        </section>

        <section class="panel">
          <h2>Experiments Overview</h2>
          <form id="experiments-filter-form" class="split">
            <div>
              <label>Listing ID</label>
              <input
                type="number"
                name="listing_id"
                placeholder="Filter by listing"
              />
            </div>
            <div>
              <label>State</label>
              <input type="text" name="state" placeholder="proposed" />
            </div>
            <button type="submit" class="primary">List Experiments</button>
          </form>
        </section>

      </div>
      <section class="panel" style="flex: 0.9; max-width: 480px">
        <h2>Log</h2>
        <div id="log" class="log"></div>
      </section>
    </main>

    <script>
      const baseUrlInput = document.getElementById("base-url");
      const logContainer = document.getElementById("log");
      const STORAGE_KEY = "auto-etsy-api-base-url";
      const savedBaseUrl = localStorage.getItem(STORAGE_KEY);
      if (savedBaseUrl) {
        baseUrlInput.value = savedBaseUrl;
      }

      baseUrlInput.addEventListener("change", () => {
        localStorage.setItem(STORAGE_KEY, baseUrlInput.value.trim());
      });

      const formatJson = (value) =>
        typeof value === "string" ? value : JSON.stringify(value, null, 2);

      function appendLog(title, payload, variant = "info") {
        const entry = document.createElement("article");
        entry.className = `log-entry ${variant === "error" ? "error" : ""}`;

        const heading = document.createElement("h3");
        heading.textContent = title;
        entry.appendChild(heading);

        const pre = document.createElement("pre");
        pre.textContent = formatJson(payload ?? "(empty response)");
        entry.appendChild(pre);

        logContainer.prepend(entry);
      }

      function clearLog() {
        logContainer.innerHTML = "";
      }

      function buildUrl(path, query) {
        const trimmedBase = baseUrlInput.value.trim().replace(/\/+$/, "");
        const url = new URL(`${trimmedBase}${path}`);
        if (query) {
          Object.entries(query).forEach(([key, value]) => {
            if (value === undefined || value === null || value === "") {
              return;
            }
            url.searchParams.append(key, value);
          });
        }
        return url;
      }

      async function callApi(path, { method = "GET", body, query } = {}) {
        const url = buildUrl(path, query);
        const options = { method, headers: {} };

        if (method !== "GET" && method !== "HEAD") {
          options.headers["Content-Type"] = "application/json";
          if (body && Object.keys(body).length) {
            options.body = JSON.stringify(body);
          }
        }

        const response = await fetch(url, options);
        const text = await response.text();
        let data = text;
        try {
          data = text ? JSON.parse(text) : null;
        } catch (err) {
          // leave as raw text
        }
        if (!response.ok) {
          const error = new Error("Request failed");
          error.status = response.status;
          error.payload = data;
          throw error;
        }
        return data;
      }

      function collectFormData(form) {
        const formData = new FormData(form);
        const payload = {};
        formData.forEach((value, key) => {
          if (value === null) {
            return;
          }
          const textValue = typeof value === "string" ? value.trim() : value;
          if (textValue === "") {
            return;
          }
          if (textValue === "true") {
            payload[key] = true;
            return;
          }
          if (textValue === "false") {
            payload[key] = false;
            return;
          }
          const numericValue = Number(textValue);
          if (
            !Number.isNaN(numericValue) &&
            textValue === String(numericValue)
          ) {
            payload[key] = numericValue;
            return;
          }
          payload[key] = textValue;
        });

        form.querySelectorAll('input[type="checkbox"]').forEach((input) => {
          if (!input.name) {
            return;
          }
          if (!formData.has(input.name)) {
            payload[input.name] = false;
          }
        });
        return payload;
      }

      function handleError(action, error) {
        const payload = {
          message: error.message,
          status: error.status,
          details: error.payload,
        };
        appendLog(action, payload, "error");
      }

      document
        .getElementById("health-btn")
        .addEventListener("click", async () => {
          try {
            const data = await callApi("/health");
            appendLog("Health Check", data);
          } catch (error) {
            handleError("Health Check", error);
          }
        });

      document
        .getElementById("clear-log-btn")
        .addEventListener("click", clearLog);

      document
        .getElementById("listings-btn")
        .addEventListener("click", async () => {
          try {
            const data = await callApi("/listings");
            appendLog("Listings", data);
          } catch (error) {
            handleError("Listings", error);
          }
        });

      document
        .getElementById("proposals-btn")
        .addEventListener("click", async () => {
          try {
            const data = await callApi("/experiments/proposals");
            appendLog("Proposals", data);
          } catch (error) {
            handleError("Proposals", error);
          }
        });

      document
        .getElementById("experiments-btn")
        .addEventListener("click", async () => {
          try {
            const data = await callApi("/experiments");
            appendLog("Experiments", data);
          } catch (error) {
            handleError("Experiments", error);
          }
        });

      document
        .getElementById("testing-btn")
        .addEventListener("click", async () => {
          try {
            const data = await callApi("/experiments/testing");
            appendLog("Testing Experiments", data);
          } catch (error) {
            handleError("Testing Experiments", error);
          }
        });

      document
        .getElementById("untested-btn")
        .addEventListener("click", async () => {
          try {
            const data = await callApi("/experiments/untested");
            appendLog("Untested Experiments", data);
          } catch (error) {
            handleError("Untested Experiments", error);
          }
        });

      document
        .getElementById("reports-btn")
        .addEventListener("click", async () => {
          try {
            const data = await callApi("/reports");
            appendLog("Reports", data);
          } catch (error) {
            handleError("Reports", error);
          }
        });

      document
        .getElementById("insights-btn")
        .addEventListener("click", async () => {
          try {
            const data = await callApi("/insights/active");
            appendLog("Active Insights", data);
          } catch (error) {
            handleError("Active Insights", error);
          }
        });

      document
        .getElementById("sync-form")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const body = collectFormData(event.target);
          try {
            const data = await callApi("/sync", { method: "POST", body });
            appendLog("Sync Listings", data);
          } catch (error) {
            handleError("Sync Listings", error);
          }
        });

      document
        .getElementById("listings-filter-form")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const query = collectFormData(event.target);
          try {
            const data = await callApi("/listings", { query });
            appendLog("Listings (filtered)", data);
          } catch (error) {
            handleError("Listings (filtered)", error);
          }
        });

      document
        .getElementById("generate-proposals-form")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const body = collectFormData(event.target);
          try {
            const data = await callApi("/experiments/proposals", {
              method: "POST",
              body,
            });
            appendLog("Generate Proposals", data);
          } catch (error) {
            handleError("Generate Proposals", error);
          }
        });

      document
        .getElementById("evaluate-form")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const data = collectFormData(event.target);
          const { listing_id, experiment_id, tolerance, comparison_date } =
            data;
          let path = `/experiments/${listing_id}/${experiment_id}/evaluate`;
          const body = {};
          if (typeof tolerance !== "undefined") {
            body.tolerance = tolerance;
          }
          if (comparison_date) {
            body.comparison_date = comparison_date;
          }
          try {
            const response = await callApi(path, { method: "POST", body });
            appendLog("Evaluate Experiment", response);
          } catch (error) {
            handleError("Evaluate Experiment", error);
          }
        });

      document
        .getElementById("experiments-filter-form")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const query = collectFormData(event.target);
          try {
            const data = await callApi("/experiments", { query });
            appendLog("Experiments (filtered)", data);
          } catch (error) {
            handleError("Experiments (filtered)", error);
          }
        });

      document
        .getElementById("accept-form")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const { listing_id, experiment_id } = collectFormData(event.target);
          const path = `/experiments/${listing_id}/${experiment_id}/accept`;
          try {
            const response = await callApi(path, { method: "POST" });
            appendLog("Accept Experiment", response);
          } catch (error) {
            handleError("Accept Experiment", error);
          }
        });

      document
        .getElementById("keep-form")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const { listing_id, experiment_id } = collectFormData(event.target);
          const path = `/experiments/${listing_id}/${experiment_id}/keep`;
          try {
            const response = await callApi(path, { method: "POST" });
            appendLog("Mark Experiment Kept", response);
          } catch (error) {
            handleError("Mark Experiment Kept", error);
          }
        });

      document
        .getElementById("revert-form")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const { listing_id, experiment_id } = collectFormData(event.target);
          const path = `/experiments/${listing_id}/${experiment_id}/revert`;
          try {
            const response = await callApi(path, { method: "POST" });
            appendLog("Revert Experiment", response);
          } catch (error) {
            handleError("Revert Experiment", error);
          }
        });

      document
        .getElementById("generate-report-form")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const body = collectFormData(event.target);
          try {
            const data = await callApi("/reports", { method: "POST", body });
            appendLog("Generate Report", data);
          } catch (error) {
            handleError("Generate Report", error);
          }
        });

      document
        .getElementById("activate-insights-form")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const { report_id, insight_ids } = collectFormData(event.target);
          const parsedIds = String(insight_ids || "")
            .split(",")
            .map((id) => id.trim())
            .filter(Boolean);
          const path = `/reports/${report_id}/activate_insights`;
          try {
            const data = await callApi(path, {
              method: "POST",
              body: { insight_ids: parsedIds },
            });
            appendLog("Activate Insights", data);
          } catch (error) {
            handleError("Activate Insights", error);
          }
        });

      document
        .getElementById("deactivate-insights-form")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const { insight_ids } = collectFormData(event.target);
          const parsedIds = String(insight_ids || "")
            .split(",")
            .map((id) => id.trim())
            .filter(Boolean);
          try {
            const data = await callApi("/insights/active/deactivate", {
              method: "POST",
              body: { insight_ids: parsedIds },
            });
            appendLog("Deactivate Insights", data);
          } catch (error) {
            handleError("Deactivate Insights", error);
          }
        });
    </script>
  </body>
</html>
